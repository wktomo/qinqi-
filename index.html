<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº²æˆšç§°å‘¼è®¡ç®—å™¨ - å†ä¹Ÿä¸æ€•å«é”™äºº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe8e8 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        .calculator {
            background: white;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            max-width: 420px;
            width: 100%;
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 22px;
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .display-path {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 12px 15px;
            min-height: 50px;
            margin-bottom: 12px;
            font-size: 13px;
            line-height: 1.6;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.3s;
        }

        .display-path.active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.02);
        }

        .display-result {
            background: white;
            border-radius: 12px;
            padding: 20px;
            color: #333;
            transition: all 0.3s;
        }

        .result-text {
            font-size: 36px;
            font-weight: bold;
            color: #ffb005;
            animation: scaleIn 0.3s ease;
            min-height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0.5; }
            to { transform: scale(1); opacity: 1; }
        }

        .result-hint {
            font-size: 11px;
            color: #999;
            margin-top: 6px;
            min-height: 16px;
        }

        .controls {
            background: #f8f9fa;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
        }

        .sex-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sex-toggle span {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .sex-btn {
            padding: 7px 15px;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .sex-btn:active {
            transform: scale(0.95);
        }

        .sex-btn.male {
            background: linear-gradient(135deg, #4dabf7 0%, #339af0 100%);
            color: white;
        }

        .sex-btn.female {
            background: linear-gradient(135deg, #ff6b9d 0%, #ff5286 100%);
            color: white;
        }
        .reverse-btn {
            padding: 7px 15px;
            background: #e7f5ff;
            color: #1971c2;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .reverse-btn:hover {
            background: #d0ebff;
            transform: translateY(-1px);
        }
        .reverse-btn:active {
            transform: translateY(0);
        }
        .actions {
            padding: 10px 15px;
            background: transparent;
            display: flex;
            gap: 12px;
        }

        .action-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
        }
        .back-btn {
            background: linear-gradient(145deg, #ffb066, #ff922b);
            box-shadow: 0 4px 0 #e88625, 0 8px 15px rgba(255, 146, 43, 0.3);
        }
        
        .back-btn:active:not(:disabled) {
            transform: translateY(4px);
            box-shadow: 0 0 0 #e88625, inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .back-btn:disabled {
            background: #e9ecef;
            color: #adb5bd;
            box-shadow: none;
            transform: none;
            cursor: not-allowed;
        }
        .clear-btn {
            background: linear-gradient(145deg, #c52094, #fa5252);
            box-shadow: 0 4px 0 #c92a2a, 0 8px 15px rgba(240, 62, 62, 0.3);
        }

        .clear-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #c92a2a, inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .keypad {
            padding: 20px 15px 15px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .key {
            aspect-ratio: 1.1; /* ç¨å¾®æ‰ä¸€ç‚¹ï¼Œè§†è§‰æ›´ç¨³ */
            border: none;
            background: linear-gradient(145deg, #ff8e8e, #ff6b6b);
            color: white;
            font-size: 20px;
            font-weight: 600;
            border-radius: 18px;
            cursor: pointer;
            box-shadow: 0 5px 0 #e04f4f, 0 12px 20px rgba(255, 107, 107, 0.35);
            transition: all 0.1s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            -webkit-user-select: none; 
            user-select: none;
        }

        .key::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .key:active::before {
            width: 100%;
            height: 100%;
        }

        .key:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 0 #e04f4f, 0 15px 25px rgba(255, 107, 107, 0.4);
        }

        .key:active {
            transform: translateY(5px); /* å‘ä¸‹ç§»åŠ¨ï¼ŒæŠµæ¶ˆé˜´å½±é«˜åº¦ */
            box-shadow: 0 0 0 #e04f4f, inset 0 3px 5px rgba(0,0,0,0.1); /* é˜´å½±æ¶ˆå¤±+å†…é˜´å½± */
        }

        /* æŒ‰é’®ä¸Šçš„å°å­—æ ‡ç­¾ */
        .key-label {
            font-size: 10px;
            margin-top: 4px;
            opacity: 0.85;
            font-weight: 400;
        }

        .footer {
            padding: 15px 20px;
            text-align: center;
            font-size: 11px;
            color: #adb5bd;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 5px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #868e96;
        }

        .stat-number {
            font-weight: bold;
            color: #ff6b6b;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 350px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
        }

        .modal-body {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        @media (max-width: 480px) {
            .calculator {
                border-radius: 20px;
            }

            .result-text {
                font-size: 32px;
            }

            .key {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="header">
            <h1><span>é˜¿æ˜Ÿ*</span>äº²æˆšç§°å‘¼è®¡ç®—å™¨-V1</h1>
            <div class="display-path" id="pathDisplay">è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©å…³ç³»</div>
            <div class="display-result">
                <div class="result-text" id="resultDisplay">æˆ‘</div>
                <div class="result-hint" id="hintDisplay">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹è®¡ç®—</div>
            </div>
        </div>

        <div class="controls">
            <div class="sex-toggle">
                <span>æ€§åˆ«ï¼ˆç‚¹å‡»åˆ‡æ¢ï¼‰</span>
                <button class="sex-btn male" id="sexBtn" onclick="toggleSex()">â™‚ ç”·ç”Ÿ</button>
            </div>
            <button class="reverse-btn" onclick="reverseQuery()">
                <span>ğŸ”„</span>
                <span>äº’æŸ¥</span>
            </button>
        </div>

        <div class="actions">
            <button class="action-btn back-btn" id="backBtn" onclick="handleBack()" disabled>
                <span>â†¶</span>
                <span>å›é€€</span>
            </button>
            <button class="action-btn clear-btn" onclick="handleClear()">
                <span>âœ•</span>
                <span>æ¸…ç©º</span>
            </button>
        </div>

        <div class="keypad">
            <button class="key" onclick="addRelation('f')">çˆ¶<span class="key-label">çˆ¸çˆ¸</span></button>
            <button class="key" onclick="addRelation('m')">æ¯<span class="key-label">å¦ˆå¦ˆ</span></button>
            <button class="key" onclick="addRelation('ob')">å…„<span class="key-label">å“¥å“¥</span></button>
            <button class="key" onclick="addRelation('lb')">å¼Ÿ<span class="key-label">å¼Ÿå¼Ÿ</span></button>
            <button class="key" onclick="addRelation('os')">å§<span class="key-label">å§å§</span></button>
            <button class="key" onclick="addRelation('ls')">å¦¹<span class="key-label">å¦¹å¦¹</span></button>
            <button class="key" onclick="addRelation('h')">å¤«<span class="key-label">è€å…¬</span></button>
            <button class="key" onclick="addRelation('w')">å¦»<span class="key-label">è€å©†</span></button>
            <button class="key" onclick="addRelation('s')">å­<span class="key-label">å„¿å­</span></button>
            <button class="key" onclick="addRelation('d')">å¥³<span class="key-label">å¥³å„¿</span></button>
        </div>

        <div class="footer">
            <div class="stats">
                <div class="stat-item">
                    <span>å·²é€‰å…³ç³»:</span>
                    <span class="stat-number" id="pathCount">0</span>
                </div>
                <div class="stat-item">
                    <span>å…³ç³»ä»£æ•°:</span>
                    <span class="stat-number" id="generationCount">0</span>
                </div>
            </div>
            <div>æ˜¥èŠ‚èšä¼šå¿…å¤‡ç¥å™¨ Â· å†ä¹Ÿä¸æ€•å«é”™äºº</div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">æç¤º</div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" onclick="closeModal()">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <script>
        let relationPath = [];
        let mySex = 1;
        // æ‰©å®¹ç‰ˆæ•°æ®åº“
        const relationshipDB = {
            // ====================
            // ç¬¬0ä»£ï¼šæ ¸å¿ƒ
            // ====================
            '': 'æˆ‘',
            'h': 'è€å…¬', 
            'w': 'è€å©†',
            'f': 'çˆ¸çˆ¸', 
            'm': 'å¦ˆå¦ˆ', 
            'ob': 'å“¥å“¥', 
            'lb': 'å¼Ÿå¼Ÿ', 
            'os': 'å§å§', 
            'ls': 'å¦¹å¦¹', 
            's': 'å„¿å­', 
            'd': 'å¥³å„¿',

            // ====================
            // ç¬¬1ä»£ä¸Šï¼šç¥–è¾ˆ (Grandparents)
            // ====================
            // çˆ¸çˆ¸é‚£è¾¹
            'f,f': 'çˆ·çˆ·', 
            'f,m': 'å¥¶å¥¶', 
            'f,ob': 'ä¼¯çˆ¶', 
            'f,lb': 'å”å”', 
            'f,os': 'å§‘å¦ˆ', 
            'f,ls': 'å§‘å§‘',
            // å¦ˆå¦ˆé‚£è¾¹
            'm,f': 'å§¥çˆ·', 
            'm,m': 'å§¥å§¥', 
            'm,ob': 'å¤§èˆ…', 
            'm,lb': 'èˆ…èˆ…', 
            'm,os': 'å¤§å§¨', 
            'm,ls': 'å°å§¨',

            // ====================
            // ç¬¬1ä»£ä¸‹ï¼šå­™è¾ˆ (Grandchildren)
            // ====================
            's,s': 'å­™å­', 
            's,d': 'å­™å¥³', 
            'd,s': 'å¤–å­™', 
            'd,d': 'å¤–å­™å¥³',

            // ====================
            // ç¬¬2ä»£ä¸Šï¼šæ›¾ç¥–è¾ˆ (Great-Grandparents)
            // ====================
            'f,f,f': 'æ›¾ç¥–çˆ¶', 
            'f,f,m': 'æ›¾ç¥–æ¯',
            'f,m,f': 'æ›¾å¤–ç¥–çˆ¶', 
            'f,m,m': 'æ›¾å¤–ç¥–æ¯',
            'm,f,f': 'å¤–æ›¾ç¥–çˆ¶', 
            'm,f,m': 'å¤–æ›¾ç¥–æ¯',
            'm,m,f': 'å¤–æ›¾å¤–ç¥–çˆ¶', 
            'm,m,m': 'å¤–æ›¾å¤–ç¥–æ¯',

            // ====================
            // ç¬¬2ä»£ä¸Šï¼šç¥–è¾ˆæ—ç³» (Grand Uncles/Aunts)
            // ====================
            // çˆ·çˆ·çš„å…„å¼Ÿå§å¦¹
            'f,f,ob': 'ä¼¯ç¥–çˆ¶ (å¤§çˆ·çˆ·)', 
            'f,f,lb': 'å”ç¥–çˆ¶ (äºŒçˆ·çˆ·)',
            'f,f,os': 'å§‘ç¥–æ¯ (å§‘å¥¶å¥¶)', 
            'f,f,ls': 'å§‘ç¥–æ¯ (å§‘å¥¶å¥¶)',
            // å¥¶å¥¶çš„å…„å¼Ÿå§å¦¹
            'f,m,ob': 'èˆ…ç¥–çˆ¶ (èˆ…çˆ·)', 
            'f,m,lb': 'èˆ…ç¥–çˆ¶ (èˆ…çˆ·)',
            'f,m,os': 'å§¨ç¥–æ¯ (å§¨å¥¶)', 
            'f,m,ls': 'å§¨ç¥–æ¯ (å§¨å¥¶)',
            // å§¥çˆ·çš„å…„å¼Ÿå§å¦¹
            'm,f,ob': 'ä¼¯å¤–ç¥–çˆ¶ (å¤§å§¥çˆ·)', 
            'm,f,lb': 'å”å¤–ç¥–çˆ¶ (äºŒå§¥çˆ·)',
            'm,f,os': 'å§‘å¤–ç¥–æ¯ (å§‘å§¥å§¥)', 
            'm,f,ls': 'å§‘å¤–ç¥–æ¯ (å§‘å§¥å§¥)',
            // å§¥å§¥çš„å…„å¼Ÿå§å¦¹
            'm,m,ob': 'èˆ…å¤–ç¥–çˆ¶ (èˆ…å§¥çˆ·)', 
            'm,m,lb': 'èˆ…å¤–ç¥–çˆ¶ (èˆ…å§¥çˆ·)',
            'm,m,os': 'å§¨å¤–ç¥–æ¯ (å§¨å§¥å§¥)', 
            'm,m,ls': 'å§¨å¤–ç¥–æ¯ (å§¨å§¥å§¥)',

            // ====================
            // å§»äº²å…³ç³»ï¼šé•¿è¾ˆçš„é…å¶
            // ====================
            'f,ob,w': 'ä¼¯æ¯', 
            'f,lb,w': 'å©¶å©¶',
            'f,os,h': 'å§‘çˆ¶', 
            'f,ls,h': 'å§‘çˆ¶',
            'm,ob,w': 'èˆ…å¦ˆ', 
            'm,lb,w': 'èˆ…å¦ˆ',
            'm,os,h': 'å§¨çˆ¶', 
            'm,ls,h': 'å§¨çˆ¶',

            // ====================
            // å§»äº²å…³ç³»ï¼šå¹³è¾ˆçš„é…å¶
            // ====================
            // è‡ªå·±çš„é…å¶å®¶
            'h,f': 'å…¬å…¬', 
            'h,m': 'å©†å©†',
            'w,f': 'å²³çˆ¶', 
            'w,m': 'å²³æ¯',
            
            // å…„å¼Ÿå§å¦¹çš„é…å¶
            'ob,w': 'å«‚å­', 
            'lb,w': 'å¼Ÿå¦¹',
            'os,h': 'å§å¤«', 
            'ls,h': 'å¦¹å¤«',

            // é…å¶çš„å…„å¼Ÿå§å¦¹
            'h,ob': 'å¤§ä¼¯å­', 
            'h,lb': 'å°å”å­', 
            'h,os': 'å¤§å§‘å§', 
            'h,ls': 'å°å§‘å­',
            'w,ob': 'å¤§èˆ…å“¥', 
            'w,lb': 'å°èˆ…å­', 
            'w,os': 'å¤§å§¨å§', 
            'w,ls': 'å°å§¨å­',

            // é…å¶çš„å…„å¼Ÿå§å¦¹çš„é…å¶ (å¦¯å¨Œ/è¿è¥Ÿ)
            'h,ob,w': 'å«‚å­ (å¦¯å¨Œ)', 
            'h,lb,w': 'å¼Ÿå¦¹ (å¦¯å¨Œ)',
            'w,os,h': 'å§å¤« (è¿è¥Ÿ)', 
            'w,ls,h': 'å¦¹å¤« (è¿è¥Ÿ)',

            // ====================
            // å ‚è¡¨äº² (Cousins)
            // ====================
            // 1. å ‚äº² (çˆ¶äº²çš„å…„å¼Ÿçš„å­©å­)
            'f,ob,s': 'å ‚å“¥/å¼Ÿ', 'f,ob,d': 'å ‚å§/å¦¹',
            'f,lb,s': 'å ‚å“¥/å¼Ÿ', 'f,lb,d': 'å ‚å§/å¦¹',
            
            // 2. è¡¨äº² (çˆ¶äº²çš„å§å¦¹çš„å­©å­ - å§‘è¡¨)
            'f,os,s': 'è¡¨å“¥/å¼Ÿ', 'f,os,d': 'è¡¨å§/å¦¹',
            'f,ls,s': 'è¡¨å“¥/å¼Ÿ', 'f,ls,d': 'è¡¨å§/å¦¹',
            
            // 3. è¡¨äº² (æ¯äº²çš„å…„å¼Ÿçš„å­©å­ - èˆ…è¡¨)
            'm,ob,s': 'è¡¨å“¥/å¼Ÿ', 'm,ob,d': 'è¡¨å§/å¦¹',
            'm,lb,s': 'è¡¨å“¥/å¼Ÿ', 'm,lb,d': 'è¡¨å§/å¦¹',
            
            // 4. è¡¨äº² (æ¯äº²çš„å§å¦¹çš„å­©å­ - å§¨è¡¨)
            'm,os,s': 'è¡¨å“¥/å¼Ÿ', 'm,os,d': 'è¡¨å§/å¦¹',
            'm,ls,s': 'è¡¨å“¥/å¼Ÿ', 'm,ls,d': 'è¡¨å§/å¦¹',

            // ====================
            // æ™šè¾ˆ (Nephews/Nieces)
            // ====================
            'ob,s': 'ä¾„å­', 'ob,d': 'ä¾„å¥³',
            'lb,s': 'ä¾„å­', 'lb,d': 'ä¾„å¥³',
            'os,s': 'å¤–ç”¥', 'os,d': 'å¤–ç”¥å¥³',
            'ls,s': 'å¤–ç”¥', 'ls,d': 'å¤–ç”¥å¥³',
            
            // æ™šè¾ˆçš„é…å¶
            's,w': 'å„¿åª³', 
            'd,h': 'å¥³å©¿',
            'ob,s,w': 'ä¾„åª³', 
            'ob,d,h': 'ä¾„å¥³å©¿',
            'os,s,w': 'å¤–ç”¥åª³', 
            'os,d,h': 'å¤–ç”¥å¥³å©¿',

            // ====================
            // æ›¾å­™/ç„å­™ (Great-Grandchildren)
            // ====================
            's,s,s': 'æ›¾å­™', 
            's,s,d': 'æ›¾å­™å¥³',
            's,d,s': 'å¤–æ›¾å­™', 
            's,d,d': 'å¤–æ›¾å­™å¥³',
            'd,s,s': 'å¤–æ›¾å­™', 
            'd,s,d': 'å¤–æ›¾å­™å¥³',
            'd,d,s': 'å¤–æ›¾å¤–å­™', 
            'd,d,d': 'å¤–æ›¾å¤–å­™å¥³',
            
            // ç„å­™ (ç¬¬4ä»£ä¸‹)
            's,s,s,s': 'ç„å­™', 
            's,s,s,d': 'ç„å­™å¥³',

            // ====================
            // é«˜ç¥–/å¤©ç¥– (Ancestors 4-5ä»£)
            // ====================
            'f,f,f,f': 'é«˜ç¥–çˆ¶',
            'f,f,f,m': 'é«˜ç¥–æ¯',
            'f,f,f,f,f': 'å¤©ç¥–çˆ¶',
            
            // ====================
            // äº²å®¶å…³ç³»
            // ====================
            's,w,f': 'äº²å®¶å…¬', 's,w,m': 'äº²å®¶æ¯',
            'd,h,f': 'äº²å®¶å…¬', 'd,h,m': 'äº²å®¶æ¯'
        };
        const relationNames = {
            'f': 'çˆ¸çˆ¸', 'm': 'å¦ˆå¦ˆ', 'h': 'è€å…¬', 'w': 'è€å©†',
            's': 'å„¿å­', 'd': 'å¥³å„¿', 'ob': 'å“¥å“¥', 'lb': 'å¼Ÿå¼Ÿ',
            'os': 'å§å§', 'ls': 'å¦¹å¦¹'
        };
        function addRelation(relation) {
            relationPath.push(relation);
            updateDisplay();
            document.getElementById('pathDisplay').classList.add('active');
            setTimeout(() => document.getElementById('pathDisplay').classList.remove('active'), 300);
        }
        function handleBack() {
            if (relationPath.length > 0) {
                relationPath.pop();
                updateDisplay();
            }
        }
        function handleClear() {
            if (relationPath.length === 0) {
                showModal('æç¤º', 'å½“å‰æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œæ— éœ€æ¸…ç©ºå“¦ ğŸ˜Š');
                return;
            }
            relationPath = [];
            updateDisplay();
        }
        function simplifyChain(path, sex) {
            let currentPath = [...path];
            let hasChanged = true;
            while (hasChanged) {
                hasChanged = false;
                if (currentPath.length < 2) break;

                for (let i = 0; i < currentPath.length - 1; i++) {
                    const pair = currentPath[i] + ',' + currentPath[i+1];
                    let reduced = null; // null è¡¨ç¤ºè¿™å¯¹å…³ç³»æ²¡æœ‰åŒ–ç®€é€»è¾‘

                    // --- 1. å¤«å¦»å›ç¯ (ç»å¯¹æ˜¯â€œæˆ‘â€) ---
                    if (pair === 'h,w') { // è€å…¬çš„è€å©†
                        reduced = (sex === 0) ? [] : ['w']; // å¦‚æœæˆ‘æ˜¯å¥³çš„ï¼Œé‚£å°±æ˜¯â€œæˆ‘â€(ç©ºæ•°ç»„)ï¼›å¦‚æœæˆ‘æ˜¯ç”·çš„ï¼Œé‚£å°±æ˜¯è€å©†(å®é™…ä¸Šç”·çš„ä¹Ÿæ²¡è€å…¬)
                    } else if (pair === 'w,h') { // è€å©†çš„è€å…¬
                        reduced = (sex === 1) ? [] : ['h']; // å¦‚æœæˆ‘æ˜¯ç”·çš„ï¼Œé‚£å°±æ˜¯â€œæˆ‘â€
                    }
                    else if (pair === 'os,ls') { // å§å§çš„å¦¹å¦¹
                        reduced = (sex === 0) ? [] : ['ls']; // å¥³å˜æˆ‘ï¼Œç”·å˜å¦¹å¦¹
                    } 
                    else if (pair === 'ls,os') { // å¦¹å¦¹çš„å§å§
                        reduced = (sex === 0) ? [] : ['os']; // å¥³å˜æˆ‘ï¼Œç”·å˜å§å§
                    }
                    else if (pair === 'ob,lb') { // å“¥å“¥çš„å¼Ÿå¼Ÿ
                        reduced = (sex === 1) ? [] : ['lb']; // ç”·å˜æˆ‘ï¼Œå¥³å˜å¼Ÿå¼Ÿ
                    }
                    else if (pair === 'lb,ob') { // å¼Ÿå¼Ÿçš„å“¥å“¥
                        reduced = (sex === 1) ? [] : ['ob']; // ç”·å˜æˆ‘ï¼Œå¥³å˜å“¥å“¥
                    }
                    else if (pair === 'f,s' || pair === 'm,s') {
                        reduced = (sex === 1) ? [] : ['ob']; // è¿™é‡Œæš‚å®šä¸ºå“¥å“¥ï¼Œä¹Ÿå¯èƒ½æ˜¯å¼Ÿå¼Ÿ
                    }
                    else if (pair === 'f,d' || pair === 'm,d') {
                        reduced = (sex === 0) ? [] : ['os']; // è¿™é‡Œæš‚å®šä¸ºå§å§ï¼Œä¹Ÿå¯èƒ½æ˜¯å¦¹å¦¹
                    }
                    if (reduced !== null) {
                        // åˆ é™¤è¿™ä¸¤ä¸ªæ—§èŠ‚ç‚¹ï¼Œæ’å…¥åŒ–ç®€åçš„èŠ‚ç‚¹ï¼ˆå¦‚æœæ˜¯[]å°±æ˜¯åˆ æ‰äº†ï¼Œå˜æˆäº†"æˆ‘"ï¼‰
                        currentPath.splice(i, 2, ...reduced);
                        hasChanged = true;
                        break; // é‡æ–°å¼€å§‹å¾ªç¯ï¼Œå› ä¸ºæ•°ç»„é•¿åº¦å˜äº†
                    }
                }
            }
            return currentPath;
        }
function toggleSex() {
            mySex = mySex === 1 ? 0 : 1;
            const btn = document.getElementById('sexBtn');
            btn.className = mySex === 1 ? 'sex-btn male' : 'sex-btn female';
            btn.innerHTML = mySex === 1 ? 'â™‚ ç”·ç”Ÿ' : 'â™€ å¥³ç”Ÿ';
            const keys = document.querySelectorAll('.key');
            keys.forEach(key => {
                const text = key.innerText.split('\n')[0]; // è·å–æŒ‰é’®å¤§å­—
                if (text.includes('å¤«')) {
                    key.style.opacity = mySex === 1 ? '0.5' : '1';
                    key.style.pointerEvents = mySex === 1 ? 'none' : 'auto';
                }
                if (text.includes('å¦»')) {
                    key.style.opacity = mySex === 0 ? '0.5' : '1';
                    key.style.pointerEvents = mySex === 0 ? 'none' : 'auto';
                }
            });
            if(relationPath.length > 0) handleClear();
        }
        setTimeout(toggleSex, 0); // è§¦å‘ä¸€æ¬¡çŠ¶æ€æ›´æ–°ï¼Œæ³¨æ„è¿™ä¼šé‡ç½®mySexï¼Œä½ å¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´é€»è¾‘ï¼Œæˆ–è€…ç›´æ¥åœ¨åŠ è½½å®Œåæ‰‹åŠ¨è®¾ç½®æ ·å¼ã€‚
        function reverseQuery() {
            if (relationPath.length === 0) {
                showModal('æ¸©é¦¨æç¤º', 'è¯·å…ˆé€‰æ‹©ä¸€ä¸ªäº²æˆšå…³ç³»ï¼Œç„¶åå†ä½¿ç”¨äº’æŸ¥åŠŸèƒ½æŸ¥çœ‹å¯¹æ–¹å¦‚ä½•ç§°å‘¼ä½ å“¦ï¼');
                return;
            }   
            const currentResult = calculateRelationship();
            const reverseRelation = getReverseRelationship();
            showModal(
                'äº’æŸ¥ç»“æœ', 
                `<div style="margin-bottom: 15px;">
                    <div style="color: #999; font-size: 12px; margin-bottom: 5px;">ä½ ç§°å‘¼å¯¹æ–¹ï¼š</div>
                    <div style="color: #ff6b6b; font-size: 20px; font-weight: bold;">${currentResult}</div>
                </div>
                <div>
                    <div style="color: #999; font-size: 12px; margin-bottom: 5px;">å¯¹æ–¹ç§°å‘¼ä½ ï¼š</div>
                    <div style="color: #4dabf7; font-size: 20px; font-weight: bold;">${reverseRelation}</div>
                </div>`
            );
        }
        function getReverseRelationship() {
            if (relationPath.length === 0) return 'æˆ‘';
            const reverseMap = {
                'f': 's', 'm': 's', 's': 'f', 'd': 'f',
                'ob': 'lb', 'lb': 'ob', 'os': 'ls', 'ls': 'os',
                'h': 'w', 'w': 'h'
            };
            const reversed = [];
            for (let i = relationPath.length - 1; i >= 0; i--) {
                const rel = relationPath[i];
                if (reverseMap[rel]) {
                    reversed.push(reverseMap[rel]);
                }
            }
            if (reversed.length > 0) {
                const key = reversed.join(',');
                return relationshipDB[key] || 'å¯¹åº”ç§°å‘¼';
            }
            return 'å¯¹åº”ç§°å‘¼';
        }
        function showModal(title, body) {
            document.getElementById('modalTitle').innerHTML = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modal').classList.add('show');
        }
        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        function calculateRelationship() {
            const simplifiedPath = simplifyChain(relationPath, mySex);
            if (simplifiedPath.length === 0) return 'æˆ‘';
            const fullKey = simplifiedPath.join(',');
            if (relationshipDB[fullKey]) return relationshipDB[fullKey];
            const isAllFather = simplifiedPath.every(r => r === 'f');
            if (isAllFather) {
                if (simplifiedPath.length === 4) return 'é«˜ç¥–çˆ¶';
                if (simplifiedPath.length === 5) return 'å¤©ç¥–çˆ¶';
                if (simplifiedPath.length === 6) return 'çƒˆç¥–çˆ¶';
                if (simplifiedPath.length >= 7) return 'å¤ªç¥–çˆ¶';
            }
            for (let i = simplifiedPath.length - 1; i > 0; i--) {
                const subPath = simplifiedPath.slice(0, i);
                const subKey = subPath.join(',');
                
                if (relationshipDB[subKey]) {
                    const knownName = relationshipDB[subKey];
                    // æŠŠå‰©ä¸‹çš„è·¯å¾„ç›´æ¥ç¿»è¯‘æˆä¸­æ–‡
                    const remainingPath = simplifiedPath.slice(i);
                    const remainingName = remainingPath.map(code => relationNames[code]).join('çš„');
                    
                    return knownName + 'çš„' + remainingName;
                }
            }
            return simplifiedPath.map(code => relationNames[code]).join('çš„');
        }
        function calculateGeneration() {
            let generation = 0;
            for (let rel of relationPath) {
                if (rel === 'f' || rel === 'm') generation++;
                else if (rel === 's' || rel === 'd') generation--;
            }
            return Math.abs(generation);
        }
        (function() {
                document.oncontextmenu = function() { return false; };
                document.onkeydown = function(e) {
                    var k = e.keyCode || e.which;
                    var ctrl = e.ctrlKey || e.metaKey; 
                    var shift = e.shiftKey;
                    if (k === 123) return false;
                    if (ctrl && shift && (k === 73 || k === 74 || k === 67)) return false;
                    if (ctrl && k === 85) return false;
                    if (ctrl && k === 83) return false;
                };
                setInterval(function() {
                    (function(){})['constructor']('debugger')();
                }, 500);
            })();
        function updateDisplay() {
            const pathDisplay = document.getElementById('pathDisplay');
            const resultDisplay = document.getElementById('resultDisplay');
            const hintDisplay = document.getElementById('hintDisplay');
            const backBtn = document.getElementById('backBtn');
            const pathCount = document.getElementById('pathCount');
            const generationCount = document.getElementById('generationCount');
            if (relationPath.length === 0) {
                pathDisplay.textContent = 'åç»­äº§å“è¯·æŒç»­å…³æ³¨é˜¿æ˜Ÿ';
            } else {
                const pathText = relationPath.map(r => relationNames[r]).join(' çš„ ');
                pathDisplay.textContent = 'æˆ‘ çš„ ' + pathText;
            }
            const result = calculateRelationship();
            resultDisplay.textContent = result;            
            if (result.length > 5) {
                resultDisplay.style.fontSize = '24px';
            } else {
                resultDisplay.style.fontSize = '36px';
            }
            if (result === 'æˆ‘') {
                hintDisplay.textContent = 'ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹è®¡ç®—';
            } else if (relationshipDB[relationPath.join(',')]) {
                hintDisplay.textContent = 'å‡†ç¡®ç§°å‘¼';
            } else {
                hintDisplay.textContent = 'å…³ç³»å¤ªå¤æ‚ï¼Œå·²ä¸ºæ‚¨ç”Ÿæˆç›´è¯‘ç§°å‘¼';
            }
            pathCount.textContent = relationPath.length;
            generationCount.textContent = calculateGeneration();
            backBtn.disabled = relationPath.length === 0;
        }
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' || e.key === 'Delete') {
                e.preventDefault();
                handleBack();
            } else if (e.key === 'Escape') {
                handleClear();
            }
        });
        updateDisplay();
    </script>
</body>
</html>